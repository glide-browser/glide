#!/usr/bin/env node --no-warnings --experimental-strip-types

// @ts-check

import { existsSync } from "node:fs";
import Path from "node:path";
import { ENGINE_DIR, SRC_DIR } from "../canonical-paths.mts";
import { $ } from "../zx.mts";

/**
 * Turn `src/` paths into relative `engine/` paths, this is helpful for auto-completions.
 *
 * e.g. `mach test src/glide/browser/base/content/test/config`
 *
 * @param {string} arg 
 * @returns {string}
 */
function normalize_path(arg) {
  const resolved = Path.resolve(arg);

  if (!resolved.startsWith(SRC_DIR + Path.sep)) {
    return arg;
  }

  const relative_path = Path.relative(SRC_DIR, resolved);
  const engine_path = Path.join(ENGINE_DIR, relative_path);

  if (existsSync(engine_path)) {
    return relative_path;
  }

  return arg;
}

const args = process.argv.slice(2).map(normalize_path);

await $({ cwd: ENGINE_DIR })`./mach ${args}`.catch($.handle_error);
